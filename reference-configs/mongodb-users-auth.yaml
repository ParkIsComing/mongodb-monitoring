apiVersion: v1
kind: Secret
metadata:
  name: mongodb-sharded-users
  namespace: percona-mongodb
type: Opaque
stringData:
  # ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ìž (SCRAM-SHA-1 + X.509)
  MONGODB_DATABASE_ADMIN_USER: "databaseAdmin"
  MONGODB_DATABASE_ADMIN_PASSWORD: "$(openssl rand -base64 32 | tr -d '\n')"
  
  # í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ìž (SCRAM-SHA-1 + X.509)
  MONGODB_CLUSTER_ADMIN_USER: "clusterAdmin"
  MONGODB_CLUSTER_ADMIN_PASSWORD: "$(openssl rand -base64 32 | tr -d '\n')"
  
  # ë°±ì—… ì‚¬ìš©ìž (SCRAM-SHA-1)
  MONGODB_BACKUP_USER: "backupUser"
  MONGODB_BACKUP_PASSWORD: "$(openssl rand -base64 32 | tr -d '\n')"
  
  # ëª¨ë‹ˆí„°ë§ ì‚¬ìš©ìž (SCRAM-SHA-1 + X.509)
  MONGODB_CLUSTER_MONITOR_USER: "clusterMonitor"
  MONGODB_CLUSTER_MONITOR_PASSWORD: "$(openssl rand -base64 32 | tr -d '\n')"
  
  # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ìž (SCRAM-SHA-1 + X.509)
  MONGODB_APPLICATION_USER: "appUser"
  MONGODB_APPLICATION_PASSWORD: "$(openssl rand -base64 32 | tr -d '\n')"
  
  # ì½ê¸° ì „ìš© ì‚¬ìš©ìž (SCRAM-SHA-1)
  MONGODB_READONLY_USER: "readOnlyUser"
  MONGODB_READONLY_PASSWORD: "$(openssl rand -base64 32 | tr -d '\n')"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-user-setup
  namespace: percona-mongodb
data:
  setup-users.js: |
    // MongoDB ì‚¬ìš©ìž ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
    // AWS Security ê¶Œìž¥ì‚¬í•­ì— ë”°ë¥¸ ì¸ì¦ ì„¤ì •
    
    // admin ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì „í™˜
    use admin;
    
    // 1. ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ìž ìƒì„± (SCRAM-SHA-1 + X.509)
    db.createUser({
      user: "databaseAdmin",
      pwd: process.env.MONGODB_DATABASE_ADMIN_PASSWORD,
      roles: [
        { role: "dbAdminAnyDatabase", db: "admin" },
        { role: "readWriteAnyDatabase", db: "admin" },
        { role: "userAdminAnyDatabase", db: "admin" }
      ],
      mechanisms: ["SCRAM-SHA-1", "SCRAM-SHA-256"]
    });
    
    // 2. í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ìž ìƒì„± (SCRAM-SHA-1 + X.509)
    db.createUser({
      user: "clusterAdmin",
      pwd: process.env.MONGODB_CLUSTER_ADMIN_PASSWORD,
      roles: [
        { role: "clusterAdmin", db: "admin" },
        { role: "dbAdminAnyDatabase", db: "admin" },
        { role: "userAdminAnyDatabase", db: "admin" },
        { role: "readWriteAnyDatabase", db: "admin" }
      ],
      mechanisms: ["SCRAM-SHA-1", "SCRAM-SHA-256"]
    });
    
    // 3. ë°±ì—… ì‚¬ìš©ìž ìƒì„± (SCRAM-SHA-1)
    db.createUser({
      user: "backupUser",
      pwd: process.env.MONGODB_BACKUP_PASSWORD,
      roles: [
        { role: "backup", db: "admin" },
        { role: "restore", db: "admin" },
        { role: "clusterMonitor", db: "admin" }
      ],
      mechanisms: ["SCRAM-SHA-1"]
    });
    
    // 4. ëª¨ë‹ˆí„°ë§ ì‚¬ìš©ìž ìƒì„± (SCRAM-SHA-1 + X.509)
    db.createUser({
      user: "clusterMonitor",
      pwd: process.env.MONGODB_CLUSTER_MONITOR_PASSWORD,
      roles: [
        { role: "clusterMonitor", db: "admin" },
        { role: "read", db: "local" }
      ],
      mechanisms: ["SCRAM-SHA-1", "SCRAM-SHA-256"]
    });
    
    // 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ìž ìƒì„± (SCRAM-SHA-1 + X.509)
    db.createUser({
      user: "appUser",
      pwd: process.env.MONGODB_APPLICATION_PASSWORD,
      roles: [
        { role: "readWrite", db: "myapp" },
        { role: "read", db: "analytics" }
      ],
      mechanisms: ["SCRAM-SHA-1", "SCRAM-SHA-256"]
    });
    
    // 6. ì½ê¸° ì „ìš© ì‚¬ìš©ìž ìƒì„± (SCRAM-SHA-1)
    db.createUser({
      user: "readOnlyUser",
      pwd: process.env.MONGODB_READONLY_PASSWORD,
      roles: [
        { role: "readAnyDatabase", db: "admin" }
      ],
      mechanisms: ["SCRAM-SHA-1"]
    });
    
    // 7. X.509 ì¸ì¦ì„œ ê¸°ë°˜ ì‚¬ìš©ìž ìƒì„±
    // ê´€ë¦¬ìž X.509 ì‚¬ìš©ìž (CN=admin)
    db.getSiblingDB("$external").createUser({
      user: "CN=admin,OU=Database,O=MongoDB-Cluster,L=Seoul,ST=Seoul,C=KR",
      roles: [
        { role: "clusterAdmin", db: "admin" },
        { role: "dbAdminAnyDatabase", db: "admin" },
        { role: "userAdminAnyDatabase", db: "admin" },
        { role: "readWriteAnyDatabase", db: "admin" }
      ]
    });
    
    // ì• í”Œë¦¬ì¼€ì´ì…˜ X.509 ì‚¬ìš©ìž (CN=mongodb-app-user)
    db.getSiblingDB("$external").createUser({
      user: "CN=mongodb-app-user,OU=Application,O=MongoDB-Cluster,L=Seoul,ST=Seoul,C=KR",
      roles: [
        { role: "readWrite", db: "myapp" },
        { role: "read", db: "analytics" }
      ]
    });
    
    // ëª¨ë‹ˆí„°ë§ X.509 ì‚¬ìš©ìž (CN=mongodb-monitor)
    db.getSiblingDB("$external").createUser({
      user: "CN=mongodb-monitor,OU=Monitoring,O=MongoDB-Cluster,L=Seoul,ST=Seoul,C=KR",
      roles: [
        { role: "clusterMonitor", db: "admin" },
        { role: "read", db: "local" }
      ]
    });
    
    print("âœ… ëª¨ë“  ì‚¬ìš©ìž ìƒì„± ì™„ë£Œ");
    
    // 8. ì¸ì¦ ì„¤ì • í™•ì¸
    print("ðŸ“‹ ìƒì„±ëœ ì‚¬ìš©ìž ëª©ë¡:");
    db.getUsers().forEach(function(user) {
      print("  - " + user.user + " (" + user.roles.map(r => r.role).join(", ") + ")");
    });
    
    print("ðŸ“‹ X.509 ì‚¬ìš©ìž ëª©ë¡:");
    db.getSiblingDB("$external").getUsers().forEach(function(user) {
      print("  - " + user.user);
    });

---
apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-user-setup
  namespace: percona-mongodb
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mongodb-setup
        image: percona/percona-server-mongodb:6.0.9-7
        command: ["/bin/bash"]
        args:
        - -c
        - |
          # MongoDB í´ëŸ¬ìŠ¤í„°ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          echo "MongoDB í´ëŸ¬ìŠ¤í„° ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          until mongosh --host mongodb-sharded-mongos.percona-mongodb.svc.cluster.local:27017 \
                        --tls \
                        --tlsCAFile /etc/mongodb-ssl/ca.crt \
                        --tlsCertificateKeyFile /etc/mongodb-ssl/admin-client.pem \
                        --authenticationDatabase '$external' \
                        --authenticationMechanism MONGODB-X509 \
                        --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
            echo "MongoDB ì—°ê²° ëŒ€ê¸° ì¤‘... (5ì´ˆ í›„ ìž¬ì‹œë„)"
            sleep 5
          done
          
          echo "âœ… MongoDB ì—°ê²° ì„±ê³µ - ì‚¬ìš©ìž ì„¤ì • ì‹œìž‘"
          
          # ì‚¬ìš©ìž ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          mongosh --host mongodb-sharded-mongos.percona-mongodb.svc.cluster.local:27017 \
                  --tls \
                  --tlsCAFile /etc/mongodb-ssl/ca.crt \
                  --tlsCertificateKeyFile /etc/mongodb-ssl/admin-client.pem \
                  --authenticationDatabase '$external' \
                  --authenticationMechanism MONGODB-X509 \
                  /scripts/setup-users.js
        env:
        - name: MONGODB_DATABASE_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-sharded-users
              key: MONGODB_DATABASE_ADMIN_PASSWORD
        - name: MONGODB_CLUSTER_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-sharded-users
              key: MONGODB_CLUSTER_ADMIN_PASSWORD
        - name: MONGODB_BACKUP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-sharded-users
              key: MONGODB_BACKUP_PASSWORD
        - name: MONGODB_CLUSTER_MONITOR_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-sharded-users
              key: MONGODB_CLUSTER_MONITOR_PASSWORD
        - name: MONGODB_APPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-sharded-users
              key: MONGODB_APPLICATION_PASSWORD
        - name: MONGODB_READONLY_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-sharded-users
              key: MONGODB_READONLY_PASSWORD
        volumeMounts:
        - name: user-setup-script
          mountPath: /scripts
        - name: ssl-certs
          mountPath: /etc/mongodb-ssl
          readOnly: true
      volumes:
      - name: user-setup-script
        configMap:
          name: mongodb-user-setup
      - name: ssl-certs
        projected:
          sources:
          - secret:
              name: mongodb-ca-cert
              items:
              - key: ca.crt
                path: ca.crt
          - secret:
              name: mongodb-admin-client
              items:
              - key: tls.crt
                path: admin-client-cert.pem
              - key: tls.key
                path: admin-client-key.pem
          - configMap:
              name: ssl-cert-combiner
              items:
              - key: combine.sh
                path: combine.sh
                mode: 0755
      initContainers:
      - name: combine-certs
        image: busybox
        command: ["/bin/sh", "/etc/mongodb-ssl/combine.sh"]
        volumeMounts:
        - name: ssl-certs
          mountPath: /etc/mongodb-ssl

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ssl-cert-combiner
  namespace: percona-mongodb
data:
  combine.sh: |
    #!/bin/sh
    # í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œì™€ í‚¤ë¥¼ ê²°í•©
    cat /etc/mongodb-ssl/admin-client-key.pem /etc/mongodb-ssl/admin-client-cert.pem > /etc/mongodb-ssl/admin-client.pem
    chmod 600 /etc/mongodb-ssl/admin-client.pem
